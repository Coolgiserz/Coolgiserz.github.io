<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Text2SQL | NullSpace</title>
    <link>https://spacetimelab.cn/tag/text2sql/</link>
      <atom:link href="https://spacetimelab.cn/tag/text2sql/index.xml" rel="self" type="application/rss+xml" />
    <description>Text2SQL</description>
    <generator>Wowchemy (https://wowchemy.com)</generator><language>en-us</language><lastBuildDate>Sat, 16 Mar 2024 21:22:46 +0800</lastBuildDate>
    <image>
      <url>https://spacetimelab.cn/media/icon_hue03491371183284312b8b116a73ae5ab_79511_512x512_fill_lanczos_center_3.png</url>
      <title>Text2SQL</title>
      <link>https://spacetimelab.cn/tag/text2sql/</link>
    </image>
    
    <item>
      <title>Text2sql技术工具调研与框架设计</title>
      <link>https://spacetimelab.cn/post/text2sql-investigation/</link>
      <pubDate>Sat, 16 Mar 2024 21:22:46 +0800</pubDate>
      <guid>https://spacetimelab.cn/post/text2sql-investigation/</guid>
      <description>&lt;h2 id=&#34;工具&#34;&gt;工具&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://zhuanlan.zhihu.com/p/642719916&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;DB-GPT-Hub：基于LLM的Text-to-SQL解析框架&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://gitee.com/Samuelcoding/NL2SQL&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;NL2SQL: Text2SQL 语义解析数据集、解决方案、paper资源整合项目&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/BeachWang/DAIL-SQL&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/BeachWang/DAIL-SQL&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.ai2sql.io/text2sql&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Text2SQL: A Powerful Tool for Querying Databases with Natural Language&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;功能需求分类&#34;&gt;功能需求分类&lt;/h2&gt;
&lt;h3 id=&#34;基本需求&#34;&gt;基本需求&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;单数据库、单数据表&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;单数据库、多数据表&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;多数据库、多数据表&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;安全需求&#34;&gt;安全需求&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;防止自然语言触发的SQL注入&lt;/p&gt;
&lt;p&gt;需要sql注入检测、过滤机制&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;防止自然语言生成的DDOS数据库攻击/执行高耗时语句&lt;/p&gt;
&lt;p&gt;需要熔断机制&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;应用场景示例&#34;&gt;应用场景示例&lt;/h2&gt;
&lt;p&gt;用户输入意图：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;离西丽站最近的50个博物院，生成pgsql,xxxx(prompt)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;生成SQL：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;WITH station_location AS &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    SELECT ST_GeomFromText&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;SRID=4326;POINT(114.2 22.37)&amp;#39;&lt;/span&gt;, 4326&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; AS location          -- Replace x_coord and y_coord with actual coordinates
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;SELECT m.instname, m.geo, ST_Distance&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;m.geo, s.location&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; AS distance
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;FROM museum m, station_location s
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;WHERE ST_DWithin&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;m.geo, s.location, 500&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;ORDER BY distance ASC
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;LIMIT 50&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;执行查询：&lt;/p&gt;
&lt;p&gt;















&lt;figure  &gt;
  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;
    &lt;div class=&#34;w-100&#34; &gt;&lt;img alt=&#34;&#34; srcset=&#34;
               /post/text2sql-investigation/images/demo/query_museum_hu42f84c661dd7c8c6e1196620aa110334_296943_c6ba022baed06dda7048ea615c7ef28a.webp 400w,
               /post/text2sql-investigation/images/demo/query_museum_hu42f84c661dd7c8c6e1196620aa110334_296943_03c83870d946ee3cb848725c5b39cc0b.webp 760w,
               /post/text2sql-investigation/images/demo/query_museum_hu42f84c661dd7c8c6e1196620aa110334_296943_1200x1200_fit_q75_h2_lanczos_3.webp 1200w&#34;
               src=&#34;https://spacetimelab.cn/post/text2sql-investigation/images/demo/query_museum_hu42f84c661dd7c8c6e1196620aa110334_296943_c6ba022baed06dda7048ea615c7ef28a.webp&#34;
               width=&#34;760&#34;
               height=&#34;383&#34;
               loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;
  &lt;/div&gt;&lt;/figure&gt;
&lt;/p&gt;
&lt;h2 id=&#34;原理&#34;&gt;原理&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;语义解析：将自然语言输入解析成结构化数据，表示查询中涉及的概念及概念间关系&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;实体识别：表名、列名、值&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;语义匹配：将自然语言中识别出的实体与数据库中的实体进行匹配&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;查询生成：生成对应的SQL语句&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;语义解析&#34;&gt;语义解析&lt;/h3&gt;
&lt;p&gt;语义解析时，除了从用户输入中对概念实体进行识别，可能还需要精确数据（如用户希望查询或查询条件需要精细的数据：xxx名称、坐标地点、身份证号码等）查询，精确数据不一定在大模型训练数据集中存在，所以可能需要接入私有数据库或借助第三方数据API进行精细数据获取，其中会涉及用户意图细节补全。&lt;/p&gt;
&lt;h2 id=&#34;实现思路&#34;&gt;实现思路&lt;/h2&gt;
&lt;p&gt;第一步：简单考虑，针对给定的表结构提示，针对单表进行text2sql查询&lt;/p&gt;
&lt;p&gt;第二步：给定数据库，针对数据库内表结构进行text2sql&lt;/p&gt;
&lt;p&gt;第三步：给定数据库连接（只读），模型自动学习数据库表结构，生成对应prompt，进行text2SQL&lt;/p&gt;
&lt;p&gt;第四步：指定多个数据源，模型需要判断查询哪些数据源，&amp;hellip;。&lt;/p&gt;
&lt;p&gt;拓展：并行调用&lt;/p&gt;
&lt;h2 id=&#34;代码骨架设计&#34;&gt;代码骨架设计&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;模型（大语言模型）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;流水线（对话循环）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;消息&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;提示模板&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;任务（text2SQL, &amp;hellip;&amp;hellip;）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;配置&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;测试用例&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;通用工具（日志、数据库驱动、搜索引擎）&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;















&lt;figure  &gt;
  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;
    &lt;div class=&#34;w-100&#34; &gt;&lt;img alt=&#34;&#34; srcset=&#34;
               /post/text2sql-investigation/images/demo/arch_hu802ca09f74bb2120882962cb8188af10_376958_cc549d11d01570b6933fd0ea9f703d4f.webp 400w,
               /post/text2sql-investigation/images/demo/arch_hu802ca09f74bb2120882962cb8188af10_376958_6a16a73a5d83941c478193be413b48b1.webp 760w,
               /post/text2sql-investigation/images/demo/arch_hu802ca09f74bb2120882962cb8188af10_376958_1200x1200_fit_q75_h2_lanczos_3.webp 1200w&#34;
               src=&#34;https://spacetimelab.cn/post/text2sql-investigation/images/demo/arch_hu802ca09f74bb2120882962cb8188af10_376958_cc549d11d01570b6933fd0ea9f703d4f.webp&#34;
               width=&#34;760&#34;
               height=&#34;379&#34;
               loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;
  &lt;/div&gt;&lt;/figure&gt;
&lt;/p&gt;
&lt;h2 id=&#34;辅助工具&#34;&gt;辅助工具&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;搜索引擎&lt;/p&gt;
&lt;p&gt;bing search api&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;示例&#34;&gt;示例&lt;/h2&gt;
&lt;h3 id=&#34;基本测试&#34;&gt;基本测试&lt;/h3&gt;
&lt;h4 id=&#34;glm4&#34;&gt;GLM4&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;大模型是否可以判断用户问题是否“可解”&lt;/li&gt;
&lt;/ul&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;question:  世界上生与死的距离是否大于1公里？ code:  1
answer: 由于这个问题并没有直接或间接地表明需要查询数据库，也没有提供具体的数据库表结构信息，因此我无法生成相应的Postgres查询语句。根据您给出的规则，我应该返回：
0
&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;question:  屏幕前的你和屏幕前的我现在是否正在熬夜？ code:  1
由于这个问题并不包含任何直接的查询意图，我无法生成一条Postgres查询语句。因此，根据您的要求，我会返回0。

0
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;
&lt;li&gt;大模型是否可以判断现有库表结构对回答用户问题的可支持程度&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;从下面示例可以看出，虽然大模型会对作出假设给出相应的查询语句，但其也会根据给定数据库表结构来判断问题实际是否能被现有数据支持。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;question:  南京路和北京路距离有多远？ code:  1
根据用户提出的问题，似乎用户希望得知的是两个地点（可能是以“南京路”和“北京路”命名的道路）之间的距离。但是，由于没有提供具体的表结构信息，我们无法直接生成一条准确的PostgreSQL查询语句。

如果假设用户是在请求城市中具体命名的道路之间的距离，并且我们的数据库中有相关道路的地理信息，那么理论上我们可以使用postGIS的函数来计算这两点之间的距离。

以下是一个假设性的查询语句，它假定：

- 数据库中有一个名为`roads`的表，其中包含道路的名称和地理数据。
- `geom`列包含的是postGIS支持的地理数据类型，如`LINESTRING`。
- `name`列包含道路的名称。

查询语句如下：

```sql
SELECT ST_Distance(
    ST_Transform(
        ST_SetSRID(
            ST_MakePoint(
                ST_StartPoint(geom)::text, -- 假定geom是LINESTRING类型，获取起点
                ST_EndPoint(geom)::text    -- 获取终点
            ),
        4326), -- 设置为WGS84坐标系
    900913), -- 转换为米制坐标系，适合计算距离
    ST_Transform(
        ST_SetSRID(
            ST_MakePoint(
                (SELECT ST_StartPoint(geom)::text FROM roads WHERE name = &amp;#39;北京路&amp;#39;), -- 假定找到北京路的起点
                (SELECT ST_EndPoint(geom)::text FROM roads WHERE name = &amp;#39;北京路&amp;#39;)    -- 假定找到北京路的终点
            ),
        4326),
    900913)
) / 1000 AS distance_in_km
FROM roads
WHERE name = &amp;#39;南京路&amp;#39;; -- 假定找到南京路的起点和终点
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;如果数据库中不存在这样的表和列，或者用户的问题实际上与数据库查询无关，那么按照您的要求，应当返回1，因为现有的信息不足以支持用户的查询需求。&lt;/p&gt;
&lt;p&gt;由于用户的问题不是很明确，这里我假设用户确实是在查询数据库中的信息，因此提供了上述查询语句。如果实际情况下用户的问题并不涉及数据库查询，正确的回应应当是：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plaintext&#34; data-lang=&#34;plaintext&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;表示现有数据库表结构不足以支持用户的查询需求。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;
- 大模型生成的SQL是否合理
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;question:  天安门和地安门是否在同一个城市 code:  1
answer: 基于提供的参考信息，我可以判断天安门和地安门位于同一个城市，即中国的北京市。&lt;/p&gt;
&lt;p&gt;以下是针对用户可能的查询需求而生成的一条PostgreSQL查询语句（假设数据库中有一个名为&lt;code&gt;historic_buildings&lt;/code&gt;的表，且该表包含表示建筑名称和所在城市的字段）：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;COUNT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;historic_buildings&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;IN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;天安门&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;地安门&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;city&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;北京市&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果天安门和地安门的相关信息确实保存在数据库中，并且表结构如假设所述，上述查询将返回2，表示这两个建筑都位于北京市。&lt;/p&gt;
&lt;p&gt;但是，如果数据库中并没有相关表或者字段来支持查询这两个建筑的信息，那么根据您的要求，应返回1。而如果用户输入的信息中不存在查询意图，则应返回0。&lt;/p&gt;
&lt;p&gt;由于这里是假设性回答，并且没有具体的数据库结构信息，以上查询只是根据用户需求的可能情景而构造的示例。实际情况中，需要根据数据库的具体结构和内容来确定查询语句。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;&lt;/code&gt;&lt;/pre&gt;</description>
    </item>
    
  </channel>
</rss>
